<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test App - Sign In or Continue</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Try to load InstantDB from CDN (may not work - needs npm) -->
    <script type="module">
        // InstantDB App ID: 18a93a08-3f4f-4e5d-b92a-9663650d0961
        // Note: This typically requires npm install
        window.INSTANTDB_APP_ID = '18a93a08-3f4f-4e5d-b92a-9663650d0961';
    </script>
</head>
<body class="bg-gray-900">
    <!-- Auth Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full"></div>
    </div>

    <!-- Main App (hidden until auth choice made) -->
    <div id="main-app" style="display: none;">
        <div class="fixed top-4 right-4 z-50" id="auth-status"></div>
        <div class="p-8">
            <h1 class="text-3xl font-bold text-white mb-4">Test Taking App</h1>
            <div id="app-content" class="bg-white rounded-lg p-6">
                <p class="text-gray-700">App content goes here...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Global state for auth
        window.APP_AUTH_STATE = {
            mode: null, // 'authenticated' or 'anonymous'
            user: null,
            isAuthenticated: false
        };
        
        function AuthScreen() {
            const [showSignIn, setShowSignIn] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            
            const handleSignIn = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                
                try {
                    // Simulate InstantDB authentication
                    // In real app, this would be: await db.auth.signInWithPassword({ email, password })
                    
                    // For demo, accept any email/password
                    if (email && password.length >= 6) {
                        const mockUser = {
                            id: 'user_' + Date.now(),
                            email: email
                        };
                        
                        // Set auth state
                        window.APP_AUTH_STATE = {
                            mode: 'authenticated',
                            user: mockUser,
                            isAuthenticated: true
                        };
                        
                        // Update InstantDB wrapper
                        if (window.InstantDB) {
                            window.__instantDBAuthState = {
                                isAuthenticated: true,
                                userId: mockUser.id
                            };
                        }
                        
                        // Store in localStorage (will sync with InstantDB when available)
                        localStorage.setItem('app_auth_mode', 'authenticated');
                        localStorage.setItem('app_user', JSON.stringify(mockUser));
                        
                        // Show main app
                        document.getElementById('auth-screen').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                        
                        // Render auth status
                        renderAuthStatus();
                        
                        alert('‚úÖ Signed in! Your test data will be saved to InstantDB.');
                    } else {
                        setError('Please enter valid email and password (6+ characters)');
                    }
                } catch (err) {
                    setError('Sign in failed. Try again.');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };
            
            const handleAnonymous = () => {
                // Set anonymous mode
                window.APP_AUTH_STATE = {
                    mode: 'anonymous',
                    user: null,
                    isAuthenticated: false
                };
                
                // Clear any stored auth
                sessionStorage.setItem('app_auth_mode', 'anonymous');
                
                // Update InstantDB wrapper
                if (window.InstantDB) {
                    window.__instantDBAuthState = {
                        isAuthenticated: false,
                        userId: null
                    };
                }
                
                // Show main app
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                
                // Render auth status
                renderAuthStatus();
                
                alert('üìç Anonymous mode: Your data is local only and will not be saved.');
            };
            
            return (
                <div className="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
                    <div className="text-center mb-8">
                        <h1 className="text-3xl font-bold text-gray-900 mb-2">Welcome</h1>
                        <p className="text-gray-600">Choose how you want to use the app</p>
                    </div>
                    
                    {!showSignIn ? (
                        <div className="space-y-4">
                            <button
                                onClick={() => setShowSignIn(true)}
                                className="w-full bg-blue-600 text-white py-4 px-6 rounded-lg hover:bg-blue-700 transition-colors font-medium text-lg shadow-lg"
                            >
                                <div className="flex items-center justify-center space-x-2">
                                    <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clipRule="evenodd" />
                                    </svg>
                                    <span>Sign In</span>
                                </div>
                                <p className="text-sm text-blue-100 mt-1">Save your progress and sync across devices</p>
                            </button>
                            
                            <div className="relative">
                                <div className="absolute inset-0 flex items-center">
                                    <div className="w-full border-t border-gray-300"></div>
                                </div>
                                <div className="relative flex justify-center text-sm">
                                    <span className="px-2 bg-white text-gray-500">or</span>
                                </div>
                            </div>
                            
                            <button
                                onClick={handleAnonymous}
                                className="w-full bg-gray-100 text-gray-700 py-4 px-6 rounded-lg hover:bg-gray-200 transition-colors font-medium text-lg border-2 border-gray-300"
                            >
                                <div className="flex items-center justify-center space-x-2">
                                    <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd" />
                                    </svg>
                                    <span>Continue Anonymously</span>
                                </div>
                                <p className="text-sm text-gray-500 mt-1">No data saved ‚Ä¢ Fresh session each time</p>
                            </button>
                            
                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-6">
                                <div className="flex">
                                    <svg className="w-5 h-5 text-yellow-600 mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                    </svg>
                                    <div className="text-sm text-yellow-800">
                                        <strong className="font-semibold">Anonymous Mode:</strong> Your test attempts, scores, and progress will not be saved. Data is cleared when you close the browser.
                                    </div>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div>
                            <button
                                onClick={() => setShowSignIn(false)}
                                className="flex items-center text-gray-600 hover:text-gray-900 mb-4"
                            >
                                <svg className="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clipRule="evenodd" />
                                </svg>
                                Back
                            </button>
                            
                            <h2 className="text-2xl font-bold text-gray-900 mb-6">Sign In</h2>
                            
                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
                                    {error}
                                </div>
                            )}
                            
                            <form onSubmit={handleSignIn} className="space-y-4">
                                <div>
                                    <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
                                        Email
                                    </label>
                                    <input
                                        id="email"
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        required
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="your@email.com"
                                    />
                                </div>
                                
                                <div>
                                    <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">
                                        Password
                                    </label>
                                    <input
                                        id="password"
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        required
                                        minLength={6}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Minimum 6 characters</p>
                                </div>
                                
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed font-medium"
                                >
                                    {loading ? 'Signing in...' : 'Sign In'}
                                </button>
                                
                                <p className="text-xs text-gray-500 text-center mt-4">
                                    InstantDB App ID: 18a93a08-3f4f-4e5d-b92a-9663650d0961
                                </p>
                            </form>
                        </div>
                    )}
                </div>
            );
        }
        
        function renderAuthStatus() {
            const container = document.getElementById('auth-status');
            if (!container) return;
            
            function AuthStatus() {
                const [showMenu, setShowMenu] = useState(false);
                const authState = window.APP_AUTH_STATE;
                
                const handleSignOut = () => {
                    // Clear auth state
                    window.APP_AUTH_STATE = {
                        mode: null,
                        user: null,
                        isAuthenticated: false
                    };
                    
                    // Clear storage
                    localStorage.removeItem('app_auth_mode');
                    localStorage.removeItem('app_user');
                    sessionStorage.clear();
                    
                    // Clear InstantDB wrapper
                    if (window.InstantDB) {
                        window.__instantDBAuthState = {
                            isAuthenticated: false,
                            userId: null
                        };
                    }
                    
                    // Reload page
                    location.reload();
                };
                
                if (authState.mode === 'authenticated') {
                    return (
                        <div className="relative">
                            <button
                                onClick={() => setShowMenu(!showMenu)}
                                className="bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-green-700 flex items-center space-x-2"
                            >
                                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                                </svg>
                                <span className="font-medium">Signed In</span>
                            </button>
                            
                            {showMenu && (
                                <>
                                    <div className="fixed inset-0 z-10" onClick={() => setShowMenu(false)} />
                                    <div className="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl z-20 border border-gray-200">
                                        <div className="p-4 border-b border-gray-200">
                                            <div className="text-sm font-medium text-gray-900">{authState.user?.email}</div>
                                            <div className="text-xs text-green-600 mt-1">‚úì Data syncing to InstantDB</div>
                                        </div>
                                        <button
                                            onClick={handleSignOut}
                                            className="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50"
                                        >
                                            Sign Out
                                        </button>
                                    </div>
                                </>
                            )}
                        </div>
                    );
                } else {
                    return (
                        <div className="relative">
                            <button
                                onClick={() => setShowMenu(!showMenu)}
                                className="bg-gray-700 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-gray-800 flex items-center space-x-2"
                            >
                                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd" />
                                </svg>
                                <span className="font-medium">Anonymous</span>
                            </button>
                            
                            {showMenu && (
                                <>
                                    <div className="fixed inset-0 z-10" onClick={() => setShowMenu(false)} />
                                    <div className="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl z-20 border border-gray-200">
                                        <div className="p-4 border-b border-gray-200">
                                            <div className="text-sm font-medium text-gray-900">Anonymous Mode</div>
                                            <div className="text-xs text-orange-600 mt-1">‚ö† Data not saved</div>
                                        </div>
                                        <button
                                            onClick={handleSignOut}
                                            className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"
                                        >
                                            Switch to Sign In
                                        </button>
                                    </div>
                                </>
                            )}
                        </div>
                    );
                }
            }
            
            ReactDOM.render(<AuthStatus />, container);
        }
        
        // Render auth screen
        ReactDOM.render(<AuthScreen />, document.querySelector('#auth-screen > div'));
        
        // Check if already authenticated
        const savedMode = localStorage.getItem('app_auth_mode');
        const savedUser = localStorage.getItem('app_user');
        if (savedMode === 'authenticated' && savedUser) {
            window.APP_AUTH_STATE = {
                mode: 'authenticated',
                user: JSON.parse(savedUser),
                isAuthenticated: true
            };
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            renderAuthStatus();
        }
    </script>
</body>
</html>



